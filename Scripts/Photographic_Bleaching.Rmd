---
title: "Photographic_Bleaching"
author: "EL Strand"
date: "8/23/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Loading in required libraries. 
```{r}
library("vegan")
library("tidyverse")
library("lme4")
library("plotrix")
library("EnvStats")
library("car")
library("MuMIn")
```

### Reading in quality controlled color data.
Protocol for ImageJ Bleaching Score Analysis found [here](https://emmastrand.github.io/EmmaStrand_Notebook/ImageJ-Analysis-Protocols/).  
```{r}
Data <- read.csv("Data/Bleaching_ImageJ_QC.csv", header=T, sep=",", na.string="NA") #read in data file

Data <-na.omit(Data) # removing all rows with NA values
Data$SP.Time.ID <- paste0(Data$Species, "_",Data$Timepoint, "_", Data$PLUG.ID)
```

### Normalize coral color to color standards. 
```{r}
Data$Red.Norm.Coral <- Data$Red.Coral/Data$Red.Standard
Data$Green.Norm.Coral <- Data$Green.Coral/Data$Green.Standard
Data$Blue.Norm.Coral <- Data$Blue.Coral/Data$Blue.Standard
```

```{r}

score <- Data %>% select("SP.Time.ID", "PLUG.ID", "Species", "Temperature", "CO2", "Timepoint", "Red.Norm.Coral","Green.Norm.Coral", "Blue.Norm.Coral")
blch.scor <- score  %>% select("Red.Norm.Coral","Green.Norm.Coral", "Blue.Norm.Coral")
blch.scor <- as.matrix(blch.scor) #create matrix
rownames(blch.scor) <- score$SP.Time.ID #name columns in dataframe

dist <- vegdist(blch.scor, method="euclidean") #calculate distance matrix of color scores

PCA.color <- princomp(dist) #run principal components Analysis
PCA.color # view variance explained by PCs

Blch <- as.data.frame(-PCA.color$scores[,1]) #extract PC1
Blch$SP.Time.ID <- rownames(blch.scor)

Blch  <- left_join(Blch, Data, by="SP.Time.ID") #make a dataframe of PC1 and experiment factors
colnames(Blch) 

names(Blch)[1] <- "Bleaching.Score"

Blch$Timepoint <- factor(Blch$Timepoint, levels = c("Week1", "Week2", "Week3", "Week4", "Week5", "Week6", "Week7", "Week8", "Week9", "Week10", "Week11", "Week12", "Week13", "Week14", "Week15", "Week16")) 

#Blch <- Blch %>% subset(Timepoint!="Week5")

Blch$group <- paste0(Data$Temperature,"_", Data$CO2, "_",Data$Timepoint)

```

### Plot data for outliers and Write out Color Score dataframe 
```{r}

Blch.meanse <- Blch %>% group_by(Species, Treatment, Timepoint) %>%
  summarise(mean = mean(Bleaching.Score), 
            sem = std.error(Bleaching.Score))


species.names <- list(
  'Mcapitata'="Montipora capitata",
  'Pacuta'="Pocillopora acuta")
species_labeller <- function(variable,value){
  return(species.names[value])}

cols <- c("lightblue", "blue", "salmon", "red3")

Blch_plot1 <- ggplot(Blch.meanse, aes(x=Timepoint, y = mean, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~Species, scales = "free", labeller = species_labeller) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  ylab("Color Score") + # y-axis label and y axis range
  theme_classic() + 
  theme(legend.position = c(0.1,0.3)) +
  theme(legend.text = element_text(size = 7)) +
  theme(legend.title = element_text(size = 9)) +
  geom_vline(xintercept = c(7.8), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  scale_x_discrete(breaks = c("Week1", "Week2", "Week4", "Week6", "Week8", "Week12", "Week16"), labels = c("1 week", "2 week", "4 week", "6 week", "8 week", "12 week", "16 week")) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Change axis line
  axis.line = element_line(colour = "black")); Blch_plot1

#remove outliers

#remove week5 outliers
Blch <- Blch %>% filter(Timepoint != "Week5")

#remove Pacuta after week 12 for small sample size
Blch <- Blch %>% filter(Species != "Pacuta" | Timepoint != "Week13")
Blch <- Blch %>% filter(Species != "Pacuta" | Timepoint != "Week14")
Blch <- Blch %>% filter(Species != "Pacuta" | Timepoint != "Week15")
Blch <- Blch %>% filter(Species != "Pacuta" | Timepoint != "Week16")

Blch.meanse <- Blch %>% group_by(Species, Treatment, Timepoint) %>%
  summarise(mean = mean(Bleaching.Score), 
            sem = std.error(Bleaching.Score))

Blch_plot <- ggplot(Blch.meanse, aes(x=Timepoint, y = mean, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~Species, scales = "free", labeller = species_labeller) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  ylab("Color Score") + # y-axis label and y axis range
  theme_classic() + 
  theme(legend.position = c(0.1,0.3)) +
  theme(legend.text = element_text(size = 7)) +
  theme(legend.title = element_text(size = 9)) +
  geom_vline(xintercept = c(7.8), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  scale_x_discrete(breaks = c("Week1", "Week2", "Week4", "Week6", "Week8", "Week12", "Week16"), labels = c("1 week", "2 week", "4 week", "6 week", "8 week", "12 week", "16 week")) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Change axis line
  axis.line = element_line(colour = "black"))+ 
  theme(strip.text = element_text(face = "bold.italic")); Blch_plot


write.table(Blch, file = "Output/Bleaching_Score_Output.csv", append = FALSE, quote = TRUE, sep = ",", eol = "\n", na = "NA", dec = ".", row.names = TRUE, col.names = TRUE, qmethod = c("escape", "double"), fileEncoding = "")


```

# Statistics 

## Mixed effect modeling 
### Raw distribution score.
```{r}
Blch$PLUG.ID <- as.character(Blch$PLUG.ID)
Blch$Timepoint <- as.factor(Blch$Timepoint)
mcap.color <- Blch %>% filter(Species == "Mcapitata")
pacuta.color <- Blch %>% filter(Species == "Pacuta")

hist(pacuta.color$Bleaching.Score) 
hist(mcap.color$Bleaching.Score) 
# both very left/negatively skewed 
```
Data is heavily left skewed and calls for transformation.

### Testing Transformations for M.capitata

```{r}
# Testing Transformations
#Our random factors is `(1|PLUG.ID)` because fragments were repeatedly measured
Mcap_Color_sqrt <- lmer(((Bleaching.Score+500)^(1/2)) ~ Temperature*CO2*Timepoint + (1|PLUG.ID), na.action=na.omit, data=mcap.color) 
par(mfrow = c(2, 2))
hist(residuals(Mcap_Color_sqrt))
boxplot(residuals(Mcap_Color_sqrt))
qqPlot(residuals(Mcap_Color_sqrt))
plot(fitted(Mcap_Color_sqrt), residuals(Mcap_Color_sqrt))

Mcap_Color_qrt <- lmer(((Bleaching.Score+500)^(1/4)) ~ Temperature*CO2*Timepoint + (1|PLUG.ID), na.action=na.omit, data=mcap.color) 
par(mfrow = c(2, 2))
hist(residuals(Mcap_Color_qrt))
boxplot(residuals(Mcap_Color_qrt))
qqPlot(residuals(Mcap_Color_qrt))
plot(fitted(Mcap_Color_qrt), residuals(Mcap_Color_qrt))

Mcap_Color_log <- lmer(log10((Bleaching.Score+500)) ~ Temperature*CO2*Timepoint + (1|PLUG.ID), na.action=na.omit, data=mcap.color)
par(mfrow = c(2, 2))
hist(residuals(Mcap_Color_log))
boxplot(residuals(Mcap_Color_log))
qqPlot(residuals(Mcap_Color_log))
plot(fitted(Mcap_Color_log), residuals(Mcap_Color_log))

Mcap_Color_sq <- lmer(((Bleaching.Score+500)^2) ~ Temperature*CO2*Timepoint + (1|PLUG.ID), na.action=na.omit, data=mcap.color)
par(mfrow = c(2, 2))
hist(residuals(Mcap_Color_sq))
boxplot(residuals(Mcap_Color_sq))
qqPlot(residuals(Mcap_Color_sq))
plot(fitted(Mcap_Color_sq), residuals(Mcap_Color_sq))

#The data transformation that worked the best was (bleaching score +100)^2 
```

Mcapitata Model
```{r}
Mcap_Color_sq <- lmer(((Bleaching.Score+500)^2) ~ Temperature*CO2*Timepoint + (1|PLUG.ID), na.action=na.omit, data=mcap.color)

## significance of model
Anova(Mcap_Color_sq, ddf="lme4", type='III') # Type III Wald chisquare tests
```

### Testing Transformations for P acuta
```{r}

#Our random factors is `(1|PLUG.ID)` because fragments were repeatedly measured
Pacuta_Color_sqrt <- lmer(((Bleaching.Score+100)^(1/2)) ~ Temperature*CO2*Timepoint + (1|PLUG.ID), na.action=na.omit, data=pacuta.color) 
par(mfrow = c(2, 2))
hist(residuals(Pacuta_Color_sqrt))
boxplot(residuals(Pacuta_Color_sqrt))
qqPlot(residuals(Pacuta_Color_sqrt))
plot(fitted(Pacuta_Color_sqrt), residuals(Pacuta_Color_sqrt))

Pacuta_Color_qrt <- lmer(((Bleaching.Score+100)^(1/4)) ~ Temperature*CO2*Timepoint + (1|PLUG.ID), na.action=na.omit, data=pacuta.color)
par(mfrow = c(2, 2))
hist(residuals(Pacuta_Color_qrt))
boxplot(residuals(Pacuta_Color_qrt))
qqPlot(residuals(Pacuta_Color_qrt))
plot(fitted(Pacuta_Color_qrt), residuals(Pacuta_Color_qrt))

Pacuta_Color_log <- lmer(log10((Bleaching.Score+1000)) ~ Temperature*CO2*Timepoint + (1|PLUG.ID), na.action=na.omit, data=pacuta.color)
par(mfrow = c(2, 2))
hist(residuals(Pacuta_Color_log))
boxplot(residuals(Pacuta_Color_log))
qqPlot(residuals(Pacuta_Color_log))
plot(fitted(Pacuta_Color_log), residuals(Pacuta_Color_log))

Pacuta_Color_sq <- lmer(((Bleaching.Score+100)^2) ~ Temperature*CO2*Timepoint + (1|PLUG.ID), na.action=na.omit, data=pacuta.color)
par(mfrow = c(2, 2))
hist(residuals(Pacuta_Color_sq))
boxplot(residuals(Pacuta_Color_sq))
qqPlot(residuals(Pacuta_Color_sq))
plot(fitted(Pacuta_Color_sq), residuals(Pacuta_Color_sq))

#The data transformation that worked the best was (bleaching score +100)^2 
```


```{r}
Pacuta_Color_sq <- lmer(((Bleaching.Score+100)^2) ~ Temperature*CO2*Timepoint + (1|PLUG.ID), na.action=na.omit, data=pacuta.color)

## significance of model
Anova(Pacuta_Color_sq, ddf="lme4", type='III') # Type III Wald chisquare tests
```


# Plotting 

Mcap and Pacuta together.
```{r}
Blch_plot <- ggplot(Blch.meanse, aes(x=Timepoint, y = mean, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~Species, scales = "free", labeller = species_labeller) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  ylab("Color Score") + # y-axis label and y axis range
  theme_classic() + 
  theme(legend.position = c(0.1,0.3)) +
  theme(legend.text = element_text(size = 7)) +
  theme(legend.title = element_text(size = 9)) +
  geom_vline(xintercept = c(7.8), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  scale_x_discrete(breaks = c("Week1", "Week2", "Week4", "Week6", "Week8", "Week12", "Week16"), labels = c("1 week", "2 week", "4 week", "6 week", "8 week", "12 week", "16 week")) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Change axis line
  axis.line = element_line(colour = "black"))+ 
  theme(strip.text = element_text(face = "bold.italic")); Blch_plot

ggsave(file="Output/Color_Score.pdf", Blch_plot, width = 11, height = 6, units = c("in"))
ggsave(file="Output/Color_Score.png", Blch_plot, width = 11, height = 6, units = c("in"))


Mcap.info <- as.character("Montipora capitata")
Mcap.Stats <- Anova(Mcap_Color_sq, ddf="lme4", type='III') # Type III Wald chisquare tests
Pacuta.info <- as.character("Pocillopora acuta")
Pacuta.Stats <- Anova(Pacuta_Color_sq, ddf="lme4", type='III') # Type III Wald chisquare tests

#Capture statistical results to file
capture.output(Mcap.info, Mcap.Stats,  Pacuta.info, Pacuta.Stats, file="Output/Color_Score_Stat_Results.txt")


```


