---
title: "Survivorship"
author: "EL Strand"
date: "8/24/2021"
output: 
html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Loading in required libraries. 
```{r}
#library(tidyr)
library(tidyverse)
#library(reshape)
#library(stringr)
library(survival)
#library(ranger)
#library(ggplot2)
#library(dplyr)
library(ggfortify)
#library(gridExtra)
library(survminer)
#library(graphics)
#library(grid)
library(coxme)
#library(jstable)
```

Loading dataframes. 
```{r}
Data <- read.csv("Data/coral_survivorship_QC.csv", header=T, sep=",", na.string="NA", stringsAsFactors = F) #read in data file
Sample.Info <- read.csv("Data/Master_Fragment_Sheet_Drive.csv", header=T, sep=",", na.string="NA") %>%
  select(PLUG.ID, Temperature, CO2, Timepoint)
Sample.Info$group <-paste0(Sample.Info$Temperature, " Temperature"," x ",Sample.Info$CO2, " CO2") 

Data.Trt <- left_join(Sample.Info, Data, by = "PLUG.ID")
Data.Trt <- Data.Trt %>% filter(Acclimation.End== "alive")

Data.Trt$sampled <- rowSums(Data.Trt[,14:126] == "sampled", na.rm = TRUE)
Data.Trt <- Data.Trt %>% filter(sampled!= 1)

Data.Trt <- Data.Trt %>% select(PLUG.ID, group, Temperature, CO2, Timepoint, Species, Day.0:Day.112)

#Data.Trt$group <- paste0(Data.Trt$Temperature, "_",Data.Trt$CO2) 
#Data.Trt$time.group <- paste0(Data.Trt$Timepoint, "_",Data.Trt$Temperature, "_",Data.Trt$CO2) 

Data.Trt$time <- rowSums(Data.Trt[,7:119] == "alive", na.rm = TRUE)
#less than 113 = dead
Data.Trt$status <- as.numeric(as.factor(Data.Trt$Day.112))

```




Survivorship analysis. 
```{r}
### Montipora capitata
Mc.Data <- Data.Trt %>% filter(Species=="Mcapitata")
unique(Mc.Data$group)
mc.cox <- coxph(Surv(time, status) ~ Temperature * CO2, data = Mc.Data)
mc.cox 

Pa.Data <- Data.Trt %>% filter(Species=="Pacuta")
unique(Pa.Data$group)
pa.cox <- coxph(Surv(time, status) ~ Temperature * CO2, data = Pa.Data)
pa.cox

#Capture statistical results to file

Mcap.info <- as.character("Montipora capitata")
Mcap.Stats <- coxph(Surv(time, status) ~ Temperature * CO2, data = Mc.Data)
Pacuta.info <- as.character("Pocillopora acuta")
Pacuta.Stats <- coxph(Surv(time, status) ~ Temperature * CO2, data = Pa.Data)

capture.output(Mcap.info, Mcap.Stats,  Pacuta.info, Pacuta.Stats, file="Output/Survivorship_Stat_Results.txt")


```



Plotting survivorship analysis. 
```{r}
## Montipora capitata
#create survivorship curve
mc <- survfit(Surv(time, status) ~ Temperature + CO2, data = Mc.Data)
mc

splots <- list()

splots[[1]] <- ggsurvplot(mc, data=Mc.Data, size = 1,  # change line size
           fun="pct", #plot survival probability in percent
           linetype = "strata", # change line type by groups
           break.time.by = 7, # break time axis
           palette = c("lightblue", "blue", "salmon", "red3"), # custom color palette
           conf.int = TRUE, # Add confidence interval
           legend.title = "", # remove legend title
           xlab = "Timepoint",
           font.title = c(14, "bold.italic", "black"), #title italicized
           font.tickslab = c(8, "black"),
           legend.labs = c("ATAC", "ATHC","HTAC", "HTHC"), # Assign legend labels
           legend=c(0.115, 0.5))
  
splots[[1]]$plot <- splots[[1]]$plot +
  scale_x_continuous(breaks = sort(c(1,2,8,15,29,43,57,85,112)), labels = c("Day 1", "Day 2", "1 week", "2 week", "4 week", "6 week", "8 week", "12 week", "16 week")) + 
  geom_vline(xintercept = 61, linetype = "dotted") + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3))


## Pocillopora acuta

pa <- survfit(Surv(time, status) ~ Temperature + CO2, data = Pa.Data)
pa

splots[[2]] <- ggsurvplot(pa, data=Pa.Data, size = 1,  # change line size
           fun="pct", #plot survival probability in percent
           linetype = "strata", # change line type by groups
           break.time.by = 7, # break time axis
           palette = c("lightblue", "blue", "salmon", "red3"), # custom color palette
           conf.int = TRUE, # Add confidence interval
           legend.title = "", # remove legend title
           xlab = "Timepoint",
           font.title = c(14, "bold.italic", "black"), #title italicized
           font.tickslab = c(8, "black"),
           legend.labs = c("ATAC", "ATHC","HTAC", "HTHC"),  #  Assign legend labels
           legend = "none")



splots[[2]]$plot <- splots[[2]]$plot +
  scale_x_continuous(breaks = sort(c(1,2,8,15,29,43,57,85,112)), labels = c("Day 1", "Day 2", "1 week", "2 week", "4 week", "6 week", "8 week", "12 week", "16 week")) + 
  geom_vline(xintercept = 61, linetype = "dotted") + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) 
  # theme(axis.text.x = element_text(vjust = grid::unit(c(-2,0,0,0,0,0,0,0,0)), "points"))

surv <- arrange_ggsurvplots(splots, print = FALSE, ncol = 2, nrow = 1)
surv 
ggsave("Output/Survivorship.pdf", surv, width = 11, height = 6)
ggsave("Output/Survivorship.png", surv, width = 11, height = 6)

```


